<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workspace | ChatGPT-assisted PPSS Platform</title>
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body>
  <nav class="sidebar">
    <div class="logo">PPSS</div>
    <ul>
      <li><a href="index.html">
          <span class="icon-circle" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path d="M4 11.5 12 4l8 7.5V20a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-5h-4v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1z" />
            </svg>
          </span>
          <span class="nav-label">Home</span></a></li>
      <li><a href="workspace.html" class="active">
          <span class="icon-circle" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path d="M4 4h7v7H4zM13 4h7v7h-7zM4 13h7v7H4zM13 13h7v7h-7z" />
            </svg>
          </span>
          <span class="nav-label">Workspace</span></a></li>
      <li><a href="report.html">
          <span class="icon-circle" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path d="M6 20v-7m6 7V7m6 13v-4" />
              <path d="M5 13h2m4-6h2m4 9h2" />
            </svg>
          </span>
          <span class="nav-label">Report</span></a></li>
      <li><a href="settings.html">
          <span class="icon-circle" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M12 9.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5Zm8 2.5a8.05 8.05 0 0 0-.11-1.3l1.76-1.37-1.5-2.6-2.1.65a8 8 0 0 0-2.24-1.3l-.27-2.18h-3l-.27 2.18a8 8 0 0 0-2.24 1.3l-2.1-.65-1.5 2.6 1.76 1.37A8.05 8.05 0 0 0 4 12.5c0 .44.04.87.11 1.3l-1.76 1.37 1.5 2.6 2.1-.65a8 8 0 0 0 2.24 1.3l.27 2.18h3l.27-2.18a8 8 0 0 0 2.24-1.3l2.1.65 1.5-2.6-1.76-1.37c.07-.43.11-.86.11-1.3Z" />
            </svg>
          </span>
          <span class="nav-label">Settings</span></a></li>
    </ul>
  </nav>
  <main class="content workspace-main">
    <header class="workspace-header">
      <h1>Collaborative Workspace</h1>
      <p>
        Progress through the proactive product-service system strategy with guided prompts, evidence-rich visuals, and real-time
        dialogue powered by the ChatGPT API. Each stage below mirrors the workflow documented in the research article and
        captures the evolving intelligence of the design team.
      </p>
    </header>

    <section class="workflow">
      <div class="stage-navigation" role="tablist" aria-label="Workspace stages">
        <button type="button" class="stage-step active" data-stage="problem-definition" data-index="0" role="tab"
          aria-selected="true">
          <span class="step-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M12 4a8 8 0 1 0 0 16 8 8 0 0 0 0-16Z" />
              <path d="m10 14 1-3 3-1-1 3z" />
            </svg>
          </span>
          <span class="step-label">Problem Definition</span>
        </button>
        <button type="button" class="stage-step" data-stage="data-analysis" data-index="1" role="tab"
          aria-selected="false">
          <span class="step-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M6 18v-6m6 6V6m6 12v-4" />
              <path d="M5 12h2m4-6h2m4 8h2" />
            </svg>
          </span>
          <span class="step-label">Data Analysis</span>
        </button>
        <button type="button" class="stage-step" data-stage="design-alternatives" data-index="2" role="tab"
          aria-selected="false">
          <span class="step-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M9.5 3.5 7 6l2 2-4 4-2-2-2 2 6 6 2-2-2-2 4-4 2 2 2.5-2.5" />
              <path d="m15 3 6 6" />
            </svg>
          </span>
          <span class="step-label">Design/Plan Alternatives</span>
        </button>
        <button type="button" class="stage-step" data-stage="design-evaluation" data-index="3" role="tab"
          aria-selected="false">
          <span class="step-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="6" />
              <path d="m15.5 15.5 3 3" />
            </svg>
          </span>
          <span class="step-label">Design/Plan Evaluation</span>
        </button>
        <button type="button" class="stage-step" data-stage="design-decision" data-index="4" role="tab"
          aria-selected="false">
          <span class="step-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M7 4h7l5 5v11H7z" />
              <path d="M14 4v5h5" />
            </svg>
          </span>
          <span class="step-label">Design/Plan Decision</span>
        </button>
      </div>

      <div class="stage-progress" aria-hidden="true">
        <div class="stage-progress__track">
          <div class="stage-progress__fill" style="width: 0%"></div>
        </div>
        <span class="stage-progress__label">Stage 1 of 5</span>
      </div>

      <div class="stage-container">
        <article id="problem-definition" class="stage-content active" role="tabpanel">
          <div class="stage-grid">
            <div class="stage-panel narrative-panel">
              <figure class="hero-figure">
                <img src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=900&q=60"
                  alt="Designers collaborating with post-it notes" />
                <figcaption>Mapping stakeholder ambitions, constraints, and sustainability mandates for the PPSS vision.</figcaption>
              </figure>
              <div class="panel-copy">
                <h2>Clarify the Strategic Challenge</h2>
                <p>
                  Capture the drivers behind the proactive product-service system initiative. Articulate the socio-technical
                  problem, define the service boundary, and document the organizational commitments that underpin the program.
                </p>
                <p>
                  Summarize stakeholder archetypes, targeted customer experiences, and the resilience indicators emphasized in the
                  article's case study to frame the design conversation.
                </p>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2>ChatGPT Facilitation</h2>
                <p class="chat-description">Live conversation through the ChatGPT API to expand the shared understanding of the
                  PPSS challenge.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="problem-definition">
                <div class="message assistant">
                  <span class="role">ChatGPT</span>
                  <p>Welcome to the proactive product-service system workspace. How would you describe the core sustainability
                    goal driving this project?</p>
                </div>
                <div class="message user">
                  <span class="role">Designer</span>
                  <p>We want to reduce the energy footprint of our mobility service while improving accessibility for commuters.</p>
                </div>
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="problem-definition">
                <label class="visually-hidden" for="message-stage-1">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-1" class="chat-input" type="text" name="message"
                    placeholder="Compose your prompt..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="problem-definition">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="data-analysis" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel analysis-panel">
              <h2>Evidence Canvases</h2>
              <p>Select a tab to review the synthesized evidence captured for the data analysis stage.</p>
              <div class="data-tabs" role="tablist" aria-label="Data analysis evidence tabs">
                <button type="button" class="data-tab active" data-tab="patterns" role="tab" aria-selected="true">Usage
                  Patterns</button>
                <button type="button" class="data-tab" data-tab="painpoints" role="tab" aria-selected="false">Pain
                  Points</button>
                <button type="button" class="data-tab" data-tab="opportunities" role="tab" aria-selected="false">Emerging
                  Opportunities</button>
              </div>
              <div class="data-tab-content active" id="patterns" role="tabpanel">
                <img src="https://images.unsplash.com/photo-1517148815978-75f6acaaf32c?auto=format&fit=crop&w=900&q=60"
                  alt="Commuters boarding eco-friendly buses" />
                <p>
                  Demand clusters reveal peak travel loads across transit corridors. ChatGPT assists by explaining latent
                  correlations between commuter behaviors and service downtimes extracted from the case study dataset.
                </p>
              </div>
              <div class="data-tab-content" id="painpoints" role="tabpanel" hidden>
                <img src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=900&q=60"
                  alt="A commuter struggling with a ticketing kiosk" />
                <p>
                  Incident narratives expose accessibility barriers and energy-intensive detours. The assistant recommends
                  service blueprints that minimize waiting time while improving the carbon performance of the fleet.
                </p>
              </div>
              <div class="data-tab-content" id="opportunities" role="tabpanel" hidden>
                <img src="https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=900&q=60"
                  alt="Aerial view of a smart mobility hub" />
                <p>
                  Emerging mobility hubs introduce modular charging nodes and predictive maintenance. ChatGPT highlights
                  partnerships that can co-create regenerative value propositions aligned with the PPSS platform.
                </p>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2>Analytical Dialogue</h2>
                <p class="chat-description">Interrogate datasets with contextual prompts and retrieve quantitative or qualitative
                  insights generated via the ChatGPT API.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="data-analysis">
                <div class="message assistant">
                  <span class="role">ChatGPT</span>
                  <p>I can summarize the variance in ridership across weekdays versus weekends. Would you like a chart-ready
                    breakdown?</p>
                </div>
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="data-analysis">
                <label class="visually-hidden" for="message-stage-2">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-2" class="chat-input" type="text" name="message"
                    placeholder="Ask about anomalies, clusters, or correlations..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="data-analysis">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="design-alternatives" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel gallery-panel">
              <h2>Concept Visualizations</h2>
              <p>
                Preview images generated through the ChatGPT image pipeline to provoke conversations on modular service concepts.
              </p>
              <div class="image-strip">
                <figure>
                  <img src="https://images.unsplash.com/photo-1535223289827-42f1e9919769?auto=format&fit=crop&w=800&q=60"
                    alt="Futuristic eco-friendly shuttle design" />
                  <figcaption>Autonomous shuttle concept with adaptive lighting.</figcaption>
                </figure>
                <figure>
                  <img src="https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=800&q=60"
                    alt="Smart mobility service hub at dusk" />
                  <figcaption>Service hub integrating micro-mobility drop-off points.</figcaption>
                </figure>
                <figure>
                  <img src="https://images.unsplash.com/photo-1529429617124-aee5b8d711b5?auto=format&fit=crop&w=800&q=60"
                    alt="Interior of an accessible transit pod" />
                  <figcaption>Universal design interior layout for inclusive commuting.</figcaption>
                </figure>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2>Co-creation Dialogue</h2>
                <p class="chat-description">Iterate on alternative concepts, assess feasibility, and request synthesized design
                  briefs from the ChatGPT API.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="design-alternatives">
                <div class="message assistant">
                  <span class="role">ChatGPT</span>
                  <p>Shall I compare the lifecycle emissions for the three proposed shuttle configurations?</p>
                </div>
                <div class="message user">
                  <span class="role">Engineer</span>
                  <p>Yes, prioritize recycled materials and modular upgrades for long-term adaptability.</p>
                </div>
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="design-alternatives">
                <label class="visually-hidden" for="message-stage-3">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-3" class="chat-input" type="text" name="message"
                    placeholder="Describe a new alternative..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="design-alternatives">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="design-evaluation" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel evaluation-panel">
              <h2>Prototype Snapshots</h2>
              <p>Review the captured evidence from service pilots to determine the viability of shortlisted alternatives.</p>
              <div class="photo-grid">
                <figure class="evaluation-photo" data-image-id="prototype-shuttle">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1529429617124-aee5b8d711b5?auto=format&fit=crop&w=1400&q=80"
                      alt="Passengers boarding a prototype shuttle" />
                    <button type="button" class="photo-zoom" aria-label="View passengers boarding a prototype shuttle">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" />
                        <path d="m15.5 15.5 3 3" />
                      </svg>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Live usability study on the adaptive shuttle entry sequence.</figcaption>
                  <label class="ranking-control" for="rank-prototype-shuttle">
                    <span>Assign a rank</span>
                    <select id="rank-prototype-shuttle" class="ranking-select" data-image-id="prototype-shuttle">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 — Leading Concept</option>
                      <option value="2">Rank 2 — Strong Contender</option>
                      <option value="3">Rank 3 — Needs Refinement</option>
                      <option value="4">Rank 4 — Backup Option</option>
                      <option value="5">Rank 5 — Limited Fit</option>
                      <option value="6">Rank 6 — Low Alignment</option>
                      <option value="7">Rank 7 — Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="telemetry-dashboard">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?auto=format&fit=crop&w=1400&q=80"
                      alt="Designers reviewing analytics on a large screen" />
                    <button type="button" class="photo-zoom" aria-label="View designers reviewing analytics on a large screen">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" />
                        <path d="m15.5 15.5 3 3" />
                      </svg>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Integrated telemetry dashboard tracking energy consumption.</figcaption>
                  <label class="ranking-control" for="rank-telemetry-dashboard">
                    <span>Assign a rank</span>
                    <select id="rank-telemetry-dashboard" class="ranking-select" data-image-id="telemetry-dashboard">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 — Leading Concept</option>
                      <option value="2">Rank 2 — Strong Contender</option>
                      <option value="3">Rank 3 — Needs Refinement</option>
                      <option value="4">Rank 4 — Backup Option</option>
                      <option value="5">Rank 5 — Limited Fit</option>
                      <option value="6">Rank 6 — Low Alignment</option>
                      <option value="7">Rank 7 — Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="accessibility-trials">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1492724441997-5dc865305da7?auto=format&fit=crop&w=1400&q=80"
                      alt="Facilitators testing accessibility features" />
                    <button type="button" class="photo-zoom" aria-label="View facilitators testing accessibility features">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" />
                        <path d="m15.5 15.5 3 3" />
                      </svg>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Accessibility trials focusing on seamless transfers.</figcaption>
                  <label class="ranking-control" for="rank-accessibility-trials">
                    <span>Assign a rank</span>
                    <select id="rank-accessibility-trials" class="ranking-select" data-image-id="accessibility-trials">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 — Leading Concept</option>
                      <option value="2">Rank 2 — Strong Contender</option>
                      <option value="3">Rank 3 — Needs Refinement</option>
                      <option value="4">Rank 4 — Backup Option</option>
                      <option value="5">Rank 5 — Limited Fit</option>
                      <option value="6">Rank 6 — Low Alignment</option>
                      <option value="7">Rank 7 — Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="mobility-hub-render">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1529429617124-95b38d21fc4d?auto=format&fit=crop&w=1400&q=80"
                      alt="Rendering of a modular mobility hub" />
                    <button type="button" class="photo-zoom" aria-label="View rendering of a modular mobility hub">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" />
                        <path d="m15.5 15.5 3 3" />
                      </svg>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Regenerative mobility hub with modular charging canopies.</figcaption>
                  <label class="ranking-control" for="rank-mobility-hub-render">
                    <span>Assign a rank</span>
                    <select id="rank-mobility-hub-render" class="ranking-select" data-image-id="mobility-hub-render">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 — Leading Concept</option>
                      <option value="2">Rank 2 — Strong Contender</option>
                      <option value="3">Rank 3 — Needs Refinement</option>
                      <option value="4">Rank 4 — Backup Option</option>
                      <option value="5">Rank 5 — Limited Fit</option>
                      <option value="6">Rank 6 — Low Alignment</option>
                      <option value="7">Rank 7 — Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="service-app-ui">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1523475472560-d2df97ec485c?auto=format&fit=crop&w=1400&q=80"
                      alt="Prototype mobile service application" />
                    <button type="button" class="photo-zoom" aria-label="View prototype mobile service application">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" />
                        <path d="m15.5 15.5 3 3" />
                      </svg>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Service orchestration app highlighting multimodal journeys.</figcaption>
                  <label class="ranking-control" for="rank-service-app-ui">
                    <span>Assign a rank</span>
                    <select id="rank-service-app-ui" class="ranking-select" data-image-id="service-app-ui">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 — Leading Concept</option>
                      <option value="2">Rank 2 — Strong Contender</option>
                      <option value="3">Rank 3 — Needs Refinement</option>
                      <option value="4">Rank 4 — Backup Option</option>
                      <option value="5">Rank 5 — Limited Fit</option>
                      <option value="6">Rank 6 — Low Alignment</option>
                      <option value="7">Rank 7 — Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="energy-dashboard">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1526498460520-4c246339dccb?auto=format&fit=crop&w=1400&q=80"
                      alt="Energy monitoring dashboard" />
                    <button type="button" class="photo-zoom" aria-label="View energy monitoring dashboard">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" />
                        <path d="m15.5 15.5 3 3" />
                      </svg>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Energy intelligence overlay for service fleet dispatch.</figcaption>
                  <label class="ranking-control" for="rank-energy-dashboard">
                    <span>Assign a rank</span>
                    <select id="rank-energy-dashboard" class="ranking-select" data-image-id="energy-dashboard">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 — Leading Concept</option>
                      <option value="2">Rank 2 — Strong Contender</option>
                      <option value="3">Rank 3 — Needs Refinement</option>
                      <option value="4">Rank 4 — Backup Option</option>
                      <option value="5">Rank 5 — Limited Fit</option>
                      <option value="6">Rank 6 — Low Alignment</option>
                      <option value="7">Rank 7 — Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="community-lab">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1400&q=80"
                      alt="Community co-design lab" />
                    <button type="button" class="photo-zoom" aria-label="View community co-design lab">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="11" cy="11" r="6" />
                        <path d="m15.5 15.5 3 3" />
                      </svg>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Community co-design lab capturing inclusive feedback.</figcaption>
                  <label class="ranking-control" for="rank-community-lab">
                    <span>Assign a rank</span>
                    <select id="rank-community-lab" class="ranking-select" data-image-id="community-lab">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 — Leading Concept</option>
                      <option value="2">Rank 2 — Strong Contender</option>
                      <option value="3">Rank 3 — Needs Refinement</option>
                      <option value="4">Rank 4 — Backup Option</option>
                      <option value="5">Rank 5 — Limited Fit</option>
                      <option value="6">Rank 6 — Low Alignment</option>
                      <option value="7">Rank 7 — Retire Concept</option>
                    </select>
                  </label>
                </figure>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2>Evaluation Dialogue</h2>
                <p class="chat-description">Deploy the ChatGPT API to quantify trade-offs, narrate customer journeys, and prioritize
                  refinements.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="design-evaluation">
                <div class="message assistant">
                  <span class="role">ChatGPT</span>
                  <p>I can simulate the service level impact if we scale the adaptive shuttle fleet. Should I run the scenario?</p>
                </div>
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="design-evaluation">
                <label class="visually-hidden" for="message-stage-4">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-4" class="chat-input" type="text" name="message"
                    placeholder="Request comparative evaluations or metrics..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="design-evaluation">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="design-decision" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel report-panel">
              <h2>Design/Plan Decision Narrative</h2>
              <p>
                Consolidate insight streams into a transparent recommendation for the proactive product-service system strategy.
              </p>
              <div class="report-body">
                <h3>Executive Summary</h3>
                <p>
                  The integrated mobility service reduces per-passenger emissions by 28% compared to the baseline. Customer
                  satisfaction improves through predictive scheduling and inclusive design touchpoints.
                </p>
                <h3>Decision Criteria</h3>
                <ul>
                  <li>Adaptive routing lowers congestion events by 18% during peak windows.</li>
                  <li>Energy-efficient materials extend vehicle lifecycles by 22%.</li>
                  <li>Service partnerships unlock three new regenerative revenue streams.</li>
                </ul>
                <h3>Next Steps</h3>
                <p>
                  Scale the telemetry stack across partner fleets, finalize stakeholder governance, and prepare a policy briefing
                  aligned with the article's recommendations.
                </p>
              </div>
            </div>
            <div class="stage-panel decision-panel">
              <h2>Design Preference Intelligence</h2>
              <p>
                Rank each concept in the evaluation gallery to reveal the preferred direction, supporting evidence, and overall
                enthusiasm before final sign-off.
              </p>
              <div class="decision-insights">
                <section class="leader-section">
                  <h3>Top Concept Spotlight</h3>
                  <p class="leader-placeholder">Rank the evaluation gallery to surface the leading service direction.</p>
                  <figure class="leader-card" hidden>
                    <div class="leader-image">
                      <img src="" alt="" />
                    </div>
                    <figcaption>
                      <p class="leader-rank"></p>
                      <h4 class="leader-title"></h4>
                      <p class="leader-contributor" hidden></p>
                      <p class="leader-affinity"></p>
                      <p class="leader-caption"></p>
                    </figcaption>
                  </figure>
                </section>
                <section class="chart-section">
                  <h3>Ranking Distribution (Bar Chart)</h3>
                  <div class="preference-chart" role="list">
                    <div class="preference-chart__row" data-image-id="prototype-shuttle" data-title="Adaptive Shuttle Entry"
                      data-contributor="Team Aurora" role="listitem">
                      <div class="preference-chart__label">
                        <span class="label-title">Adaptive Shuttle Entry</span>
                        <span class="label-meta">Team Aurora</span>
                      </div>
                      <div class="preference-chart__meter" aria-hidden="true"><span></span></div>
                      <span class="preference-chart__value">Unranked</span>
                    </div>
                    <div class="preference-chart__row" data-image-id="telemetry-dashboard"
                      data-title="Telemetry Intelligence Wall" data-contributor="Data Studio Kilo" role="listitem">
                      <div class="preference-chart__label">
                        <span class="label-title">Telemetry Intelligence Wall</span>
                        <span class="label-meta">Data Studio Kilo</span>
                      </div>
                      <div class="preference-chart__meter" aria-hidden="true"><span></span></div>
                      <span class="preference-chart__value">Unranked</span>
                    </div>
                    <div class="preference-chart__row" data-image-id="accessibility-trials"
                      data-title="Inclusive Boarding Trials" data-contributor="Accessibility Guild" role="listitem">
                      <div class="preference-chart__label">
                        <span class="label-title">Inclusive Boarding Trials</span>
                        <span class="label-meta">Accessibility Guild</span>
                      </div>
                      <div class="preference-chart__meter" aria-hidden="true"><span></span></div>
                      <span class="preference-chart__value">Unranked</span>
                    </div>
                    <div class="preference-chart__row" data-image-id="mobility-hub-render"
                      data-title="Regenerative Mobility Hub" data-contributor="Studio Meridian" role="listitem">
                      <div class="preference-chart__label">
                        <span class="label-title">Regenerative Mobility Hub</span>
                        <span class="label-meta">Studio Meridian</span>
                      </div>
                      <div class="preference-chart__meter" aria-hidden="true"><span></span></div>
                      <span class="preference-chart__value">Unranked</span>
                    </div>
                    <div class="preference-chart__row" data-image-id="service-app-ui"
                      data-title="Service Orchestration App" data-contributor="Digital Team Nova" role="listitem">
                      <div class="preference-chart__label">
                        <span class="label-title">Service Orchestration App</span>
                        <span class="label-meta">Digital Team Nova</span>
                      </div>
                      <div class="preference-chart__meter" aria-hidden="true"><span></span></div>
                      <span class="preference-chart__value">Unranked</span>
                    </div>
                    <div class="preference-chart__row" data-image-id="energy-dashboard"
                      data-title="Energy Dispatch Dashboard" data-contributor="Telemetry Collective" role="listitem">
                      <div class="preference-chart__label">
                        <span class="label-title">Energy Dispatch Dashboard</span>
                        <span class="label-meta">Telemetry Collective</span>
                      </div>
                      <div class="preference-chart__meter" aria-hidden="true"><span></span></div>
                      <span class="preference-chart__value">Unranked</span>
                    </div>
                    <div class="preference-chart__row" data-image-id="community-lab"
                      data-title="Community Co-design Lab" data-contributor="Engagement Network" role="listitem">
                      <div class="preference-chart__label">
                        <span class="label-title">Community Co-design Lab</span>
                        <span class="label-meta">Engagement Network</span>
                      </div>
                      <div class="preference-chart__meter" aria-hidden="true"><span></span></div>
                      <span class="preference-chart__value">Unranked</span>
                    </div>
                  </div>
                </section>
                <section class="chart-section pie-chart-section">
                  <h3>Preference Share (Pie Chart)</h3>
                  <div class="pie-chart-layout">
                    <div class="preference-pie" role="img"
                      aria-label="Preference share across evaluated concepts">
                      <span class="pie-chart__empty">Awaiting rankings</span>
                    </div>
                    <ul class="pie-chart__legend">
                      <li class="pie-chart__legend-item" data-image-id="prototype-shuttle"
                        style="--segment-color: var(--concept-color-1);">
                        <span class="legend-swatch" aria-hidden="true"></span>
                        <div class="legend-text">
                          <span class="legend-name">Adaptive Shuttle Entry</span>
                          <span class="legend-value">Awaiting evaluation</span>
                        </div>
                      </li>
                      <li class="pie-chart__legend-item" data-image-id="telemetry-dashboard"
                        style="--segment-color: var(--concept-color-2);">
                        <span class="legend-swatch" aria-hidden="true"></span>
                        <div class="legend-text">
                          <span class="legend-name">Telemetry Intelligence Wall</span>
                          <span class="legend-value">Awaiting evaluation</span>
                        </div>
                      </li>
                      <li class="pie-chart__legend-item" data-image-id="accessibility-trials"
                        style="--segment-color: var(--concept-color-3);">
                        <span class="legend-swatch" aria-hidden="true"></span>
                        <div class="legend-text">
                          <span class="legend-name">Inclusive Boarding Trials</span>
                          <span class="legend-value">Awaiting evaluation</span>
                        </div>
                      </li>
                      <li class="pie-chart__legend-item" data-image-id="mobility-hub-render"
                        style="--segment-color: var(--concept-color-4);">
                        <span class="legend-swatch" aria-hidden="true"></span>
                        <div class="legend-text">
                          <span class="legend-name">Regenerative Mobility Hub</span>
                          <span class="legend-value">Awaiting evaluation</span>
                        </div>
                      </li>
                      <li class="pie-chart__legend-item" data-image-id="service-app-ui"
                        style="--segment-color: var(--concept-color-5);">
                        <span class="legend-swatch" aria-hidden="true"></span>
                        <div class="legend-text">
                          <span class="legend-name">Service Orchestration App</span>
                          <span class="legend-value">Awaiting evaluation</span>
                        </div>
                      </li>
                      <li class="pie-chart__legend-item" data-image-id="energy-dashboard"
                        style="--segment-color: var(--concept-color-6);">
                        <span class="legend-swatch" aria-hidden="true"></span>
                        <div class="legend-text">
                          <span class="legend-name">Energy Dispatch Dashboard</span>
                          <span class="legend-value">Awaiting evaluation</span>
                        </div>
                      </li>
                      <li class="pie-chart__legend-item" data-image-id="community-lab"
                        style="--segment-color: var(--concept-color-7);">
                        <span class="legend-swatch" aria-hidden="true"></span>
                        <div class="legend-text">
                          <span class="legend-name">Community Co-design Lab</span>
                          <span class="legend-value">Awaiting evaluation</span>
                        </div>
                      </li>
                    </ul>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </article>
      </div>
    </section>
  </main>

  <div class="evaluation-lightbox" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="lightbox-backdrop" data-close="true"></div>
    <div class="lightbox-content">
      <button type="button" class="lightbox-close" aria-label="Close expanded prototype image" data-close="true">✕</button>
      <img class="lightbox-image" src="" alt="" />
      <p class="lightbox-caption"></p>
    </div>
  </div>

  <script>
    (function () {
      const stageButtons = Array.from(document.querySelectorAll('.stage-step'));
      const stageContents = Array.from(document.querySelectorAll('.stage-content'));
      const tabButtons = Array.from(document.querySelectorAll('.data-tab'));
      const tabPanels = Array.from(document.querySelectorAll('.data-tab-content'));
      const completeButtons = Array.from(document.querySelectorAll('.complete-stage'));
      const progressFill = document.querySelector('.stage-progress__fill');
      const progressLabel = document.querySelector('.stage-progress__label');
      const stageCount = stageButtons.length || 1;
      const STORAGE_PREFIX = 'ppss';
      const CONVERSATION_KEY = (stage) => `${STORAGE_PREFIX}-conversation-${stage}`;
      const SUMMARY_KEY = (stage) => `${STORAGE_PREFIX}-summary-${stage}`;
      const STATUS_KEY = `${STORAGE_PREFIX}-stage-status`;
      const API_KEY_STORAGE = `${STORAGE_PREFIX}-openai-key`;
      const RANKING_KEY = `${STORAGE_PREFIX}-evaluation-rankings`;

      const stageConfig = {
        'problem-definition': {
          title: 'Problem Definition',
          systemPrompt:
            'You are a proactive product-service system strategist who helps teams clarify PPSS problem statements, stakeholder drivers, and sustainability intentions.',
          summaryPrompt:
            'Summarize the PPSS problem-definition dialogue into a short paragraph highlighting the core challenge, stakeholder commitments, and sustainability intentions.'
        },
        'data-analysis': {
          title: 'Data Analysis',
          systemPrompt:
            'You are a PPSS data analyst who explains trends, anomalies, and correlations for mobility service transformation.',
          summaryPrompt:
            'Summarize the evidence interrogation by listing the most critical demand, pain point, and opportunity signals uncovered for the PPSS initiative.'
        },
        'design-alternatives': {
          title: 'Design/Plan Alternatives',
          systemPrompt:
            'You are a PPSS co-creation assistant who compares and refines alternative service concepts with lifecycle awareness.',
          summaryPrompt:
            'Summarize the alternative generation dialogue, focusing on leading concepts, differentiating value, and feasibility considerations.'
        },
        'design-evaluation': {
          title: 'Design/Plan Evaluation',
          systemPrompt:
            'You are a PPSS evaluation advisor who narrates pilot results, quantifies trade-offs, and recommends refinements.',
          summaryPrompt:
            'Summarize the evaluation dialogue, emphasizing tested scenarios, key metrics, and recommended refinements for scale-up.'
        }
      };

      function parseStoredJSON(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch (error) {
          console.warn('Unable to parse storage for', key, error);
          return fallback;
        }
      }

      const stageStatus = parseStoredJSON(STATUS_KEY, {});
      const rankingStore = parseStoredJSON(RANKING_KEY, {});

      function persistStatus(stage, completed) {
        stageStatus[stage] = completed;
        localStorage.setItem(STATUS_KEY, JSON.stringify(stageStatus));
        updateStageCompletionStyles();
      }

      function updateStageCompletionStyles() {
        stageButtons.forEach((button) => {
          const { stage } = button.dataset;
          const isComplete = Boolean(stageStatus[stage]);
          button.classList.toggle('completed', isComplete);
        });
      }

      function showStage(index) {
        stageButtons.forEach((btn, idx) => {
          const isActive = idx === index;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });

        stageContents.forEach((panel, idx) => {
          const shouldShow = idx === index;
          panel.classList.toggle('active', shouldShow);
          panel.toggleAttribute('hidden', !shouldShow);
        });

        if (progressFill) {
          const percent = stageCount > 1 ? (index / (stageCount - 1)) * 100 : 100;
          progressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
        }

        if (progressLabel) {
          progressLabel.textContent = `Stage ${index + 1} of ${stageCount}`;
        }
      }

      stageButtons.forEach((button, index) => {
        button.addEventListener('click', () => showStage(index));
      });

      const evaluationPhotos = Array.from(document.querySelectorAll('.evaluation-photo'));
      const lightbox = document.querySelector('.evaluation-lightbox');
      const lightboxImg = lightbox?.querySelector('.lightbox-image');
      const lightboxCaption = lightbox?.querySelector('.lightbox-caption');

      function openLightbox(img, caption) {
        if (!lightbox || !lightboxImg || !lightboxCaption) return;
        lightboxImg.src = img.currentSrc || img.src;
        lightboxImg.alt = img.alt || '';
        lightboxCaption.textContent = caption || '';
        lightbox.classList.add('open');
        lightbox.removeAttribute('hidden');
        lightbox.setAttribute('aria-hidden', 'false');
        document.body.classList.add('lightbox-open');
      }

      function closeLightbox() {
        if (!lightbox || !lightboxImg || !lightboxCaption) return;
        lightbox.classList.remove('open');
        lightbox.setAttribute('aria-hidden', 'true');
        lightbox.setAttribute('hidden', '');
        lightboxImg.src = '';
        lightboxImg.alt = '';
        lightboxCaption.textContent = '';
        document.body.classList.remove('lightbox-open');
      }

      evaluationPhotos.forEach((figure) => {
        const img = figure.querySelector('img');
        const caption = figure.querySelector('figcaption')?.textContent || '';
        const zoomButton = figure.querySelector('.photo-zoom');

        function handleOpen() {
          if (img) {
            openLightbox(img, caption);
          }
        }

        if (img) {
          img.addEventListener('click', handleOpen);
        }

        if (zoomButton) {
          zoomButton.addEventListener('click', handleOpen);
        }
      });

      if (lightbox) {
        lightbox.addEventListener('click', (event) => {
          if (event.target instanceof HTMLElement && event.target.dataset.close === 'true') {
            closeLightbox();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && lightbox.classList.contains('open')) {
            closeLightbox();
          }
        });
      }

      function updateRankingBadge(figure, value) {
        const badge = figure.querySelector('.ranking-badge');
        if (!badge) return;
        if (!value) {
          badge.textContent = '';
          badge.hidden = true;
          figure.classList.remove('is-ranked');
          return;
        }
        const label = `Rank ${value}`;
        badge.textContent = label;
        badge.hidden = false;
        figure.classList.add('is-ranked');
      }

      function persistRankings() {
        localStorage.setItem(RANKING_KEY, JSON.stringify(rankingStore));
      }

      const rankingSelects = Array.from(document.querySelectorAll('.ranking-select'));
      const chartRows = Array.from(document.querySelectorAll('.preference-chart__row[data-image-id]'));
      const pieChart = document.querySelector('.preference-pie');
      const pieEmptyMessage = pieChart?.querySelector('.pie-chart__empty');
      const pieLegendItems = Array.from(document.querySelectorAll('.pie-chart__legend-item[data-image-id]'));
      const pieLegendMap = pieLegendItems.reduce((acc, item) => {
        const { imageId } = item.dataset || {};
        if (imageId) {
          acc[imageId] = item;
        }
        return acc;
      }, {});
      const leaderCard = document.querySelector('.leader-card');
      const leaderPlaceholder = document.querySelector('.leader-placeholder');
      const leaderImage = leaderCard?.querySelector('img');
      const leaderTitle = leaderCard?.querySelector('.leader-title');
      const leaderContributor = leaderCard?.querySelector('.leader-contributor');
      const leaderRank = leaderCard?.querySelector('.leader-rank');
      const leaderAffinity = leaderCard?.querySelector('.leader-affinity');
      const leaderCaption = leaderCard?.querySelector('.leader-caption');

      const conceptMetadata = {};

      evaluationPhotos.forEach((figure) => {
        const imageId = figure.dataset.imageId;
        if (!imageId) return;
        const img = figure.querySelector('img');
        const caption = figure.querySelector('figcaption')?.textContent?.trim() || '';
        conceptMetadata[imageId] = {
          ...(conceptMetadata[imageId] || {}),
          image: img ? img.currentSrc || img.src || '' : conceptMetadata[imageId]?.image || '',
          alt: img?.alt || conceptMetadata[imageId]?.alt || '',
          caption: caption || conceptMetadata[imageId]?.caption || ''
        };
      });

      chartRows.forEach((row) => {
        const { imageId, title, contributor } = row.dataset;
        if (!imageId) return;
        const labelTitle = row.querySelector('.label-title')?.textContent?.trim();
        conceptMetadata[imageId] = {
          ...(conceptMetadata[imageId] || {}),
          title: title || labelTitle || conceptMetadata[imageId]?.title || '',
          contributor: contributor || conceptMetadata[imageId]?.contributor || ''
        };
      });

      function computePreference(rankValue) {
        const rankNumber = Number(rankValue);
        if (!rankValue || Number.isNaN(rankNumber)) {
          return {
            label: 'Awaiting evaluation',
            width: '0%',
            rankText: 'Unranked',
            score: 0,
            rank: null,
            percent: 0
          };
        }

        const bounded = Math.max(1, Math.min(7, rankNumber));
        const preferencePercent = Math.round(((8 - bounded) / 7) * 100);
        const qualitative =
          bounded === 1
            ? 'Priority candidate'
            : bounded <= 3
            ? 'Preferred direction'
            : bounded <= 5
            ? 'Viable alternative'
            : 'Limited alignment';

        return {
          label: `${qualitative} · ${preferencePercent}% affinity`,
          width: `${preferencePercent}%`,
          rankText: `Rank ${bounded}`,
          score: 8 - bounded,
          rank: bounded,
          percent: preferencePercent
        };
      }

      function renderPieChart(segments) {
        if (!pieChart) return;
        const totalScore = segments.reduce((sum, segment) => sum + segment.score, 0);

        if (totalScore <= 0) {
          pieChart.classList.add('is-empty');
          pieChart.style.setProperty('--pie-background', 'conic-gradient(var(--pie-empty-color) 0deg 360deg)');
          pieChart.setAttribute('aria-label', 'Preference share awaiting rankings');
          if (pieEmptyMessage) {
            pieEmptyMessage.removeAttribute('hidden');
          }
          return;
        }

        let progress = 0;
        const gradientStops = segments.map((segment) => {
          const { legendItem } = segment;
          const rawColor = legendItem
            ? getComputedStyle(legendItem).getPropertyValue('--segment-color').trim()
            : '';
          const color = rawColor || 'var(--accent-light)';
          const start = progress;
          const fraction = segment.score / totalScore;
          progress += fraction;
          const end = progress;
          const startDeg = `${(start * 360).toFixed(2)}deg`;
          const endDeg = `${(end * 360).toFixed(2)}deg`;
          return `${color} ${startDeg} ${endDeg}`;
        });

        pieChart.classList.remove('is-empty');
        pieChart.style.setProperty('--pie-background', `conic-gradient(${gradientStops.join(', ')})`);
        pieChart.setAttribute('aria-label', 'Preference share across evaluated concepts');
        if (pieEmptyMessage) {
          pieEmptyMessage.setAttribute('hidden', '');
        }
      }

      function updateDecisionInsights() {
        let topConcept = null;
        const pieSegments = [];

        chartRows.forEach((row) => {
          const { imageId } = row.dataset;
          if (!imageId) return;
          const storedRank = rankingStore[imageId];
          const preferenceInfo = computePreference(storedRank);
          const meter = row.querySelector('.preference-chart__meter span');
          const value = row.querySelector('.preference-chart__value');

          if (meter) {
            meter.style.width = preferenceInfo.width;
          }

          if (value) {
            value.textContent =
              preferenceInfo.rankText === 'Unranked'
                ? 'Unranked'
                : `${preferenceInfo.rankText} — ${preferenceInfo.label}`;
          }

          row.classList.toggle('is-ranked', Boolean(storedRank));

          const legendItem = pieLegendMap[imageId];
          if (legendItem) {
            const legendValue = legendItem.querySelector('.legend-value');
            if (legendValue) {
              legendValue.textContent = storedRank
                ? `${preferenceInfo.rankText} · ${preferenceInfo.percent}% affinity`
                : 'Awaiting evaluation';
            }
            legendItem.classList.toggle('is-ranked', Boolean(storedRank));
          }

          pieSegments.push({
            imageId,
            score: Math.max(0, preferenceInfo.score),
            legendItem,
            info: preferenceInfo
          });

          if (storedRank) {
            const meta = conceptMetadata[imageId] || {};
            const score = preferenceInfo.score;
            if (
              !topConcept ||
              score > topConcept.score ||
              (score === topConcept.score && (preferenceInfo.rank || 99) < (topConcept.rank || 99))
            ) {
              topConcept = {
                imageId,
                score,
                rank: preferenceInfo.rank,
                info: preferenceInfo,
                meta
              };
            }
          }
        });

        renderPieChart(pieSegments);

        if (topConcept && topConcept.rank) {
          if (leaderPlaceholder) {
            leaderPlaceholder.setAttribute('hidden', '');
          }
          if (leaderCard) {
            leaderCard.removeAttribute('hidden');
          }
          if (leaderImage) {
            leaderImage.src = topConcept.meta.image || '';
            leaderImage.alt = topConcept.meta.alt || topConcept.meta.title || 'Top-ranked concept';
          }
          if (leaderTitle) {
            leaderTitle.textContent = topConcept.meta.title || 'Top concept';
          }
          if (leaderContributor) {
            const contributorText = topConcept.meta.contributor ? `Contributor: ${topConcept.meta.contributor}` : '';
            if (contributorText) {
              leaderContributor.textContent = contributorText;
              leaderContributor.removeAttribute('hidden');
            } else {
              leaderContributor.textContent = '';
              leaderContributor.setAttribute('hidden', '');
            }
          }
          if (leaderRank) {
            leaderRank.textContent = `Rank ${topConcept.rank}`;
          }
          if (leaderAffinity) {
            leaderAffinity.textContent = topConcept.info.label;
          }
          if (leaderCaption) {
            leaderCaption.textContent = topConcept.meta.caption || '';
          }
        } else {
          if (leaderCard) {
            leaderCard.setAttribute('hidden', '');
            if (leaderImage) {
              leaderImage.src = '';
              leaderImage.alt = '';
            }
            if (leaderTitle) {
              leaderTitle.textContent = '';
            }
            if (leaderContributor) {
              leaderContributor.textContent = '';
              leaderContributor.setAttribute('hidden', '');
            }
            if (leaderRank) {
              leaderRank.textContent = '';
            }
            if (leaderAffinity) {
              leaderAffinity.textContent = '';
            }
            if (leaderCaption) {
              leaderCaption.textContent = '';
            }
          }
          if (leaderPlaceholder) {
            leaderPlaceholder.removeAttribute('hidden');
          }
        }
      }

      rankingSelects.forEach((select) => {
        const { imageId } = select.dataset;
        if (!imageId) return;
        const figure = document.querySelector(`.evaluation-photo[data-image-id="${imageId}"]`);
        const storedValue = rankingStore[imageId];
        if (storedValue) {
          select.value = storedValue;
          if (figure) {
            updateRankingBadge(figure, storedValue);
          }
        }

        select.addEventListener('change', () => {
          const value = select.value;
          if (value) {
            rankingStore[imageId] = value;
          } else {
            delete rankingStore[imageId];
          }
          if (figure) {
            updateRankingBadge(figure, value);
          }
          persistRankings();
          updateDecisionInsights();
        });
      });

      updateDecisionInsights();

      function showTab(id) {
        tabButtons.forEach((btn) => {
          const isActive = btn.dataset.tab === id;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });

        tabPanels.forEach((panel) => {
          const shouldShow = panel.id === id;
          panel.classList.toggle('active', shouldShow);
          panel.toggleAttribute('hidden', !shouldShow);
        });
      }

      tabButtons.forEach((button) => {
        button.addEventListener('click', () => showTab(button.dataset.tab));
      });

      function loadConversation(stage) {
        return parseStoredJSON(CONVERSATION_KEY(stage), []);
      }

      function saveConversation(stage, conversation) {
        localStorage.setItem(CONVERSATION_KEY(stage), JSON.stringify(conversation));
      }

      function appendMessage(chatLog, role, content, options = {}) {
        const message = document.createElement('div');
        message.className = `message ${role}${options.pending ? ' pending' : ''}`;
        const roleLabel =
          role === 'assistant' ? 'ChatGPT' : role === 'system' ? 'System' : 'Designer';
        const roleSpan = document.createElement('span');
        roleSpan.className = 'role';
        roleSpan.textContent = roleLabel;
        const body = document.createElement('p');
        body.textContent = content;
        message.append(roleSpan, body);
        chatLog.appendChild(message);
        chatLog.scrollTop = chatLog.scrollHeight;
        return message;
      }

      function renderStoredConversation(stage) {
        const chatLog = document.querySelector(`.chat-log[data-stage="${stage}"]`);
        if (!chatLog) return;
        const stored = loadConversation(stage);
        stored.forEach((entry) => {
          appendMessage(chatLog, entry.role, entry.content);
        });
      }

      Object.keys(stageConfig).forEach(renderStoredConversation);

      function setStageStatus(stage, message, statusClass = '') {
        const container = document.querySelector(`.stage-content#${stage} .stage-status`);
        if (!container) return;
        container.textContent = message;
        container.className = `stage-status ${statusClass}`.trim();
      }

      async function callChatGPT(messages, options = {}) {
        const { apiKey, model = 'gpt-4o' } = options;
        if (!apiKey) {
          const error = new Error('missing_api_key');
          error.code = 'missing_api_key';
          throw error;
        }

        try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model,
              messages,
              temperature: 0.4
            })
          });

          if (!response.ok) {
            const error = new Error(`OpenAI error: ${response.status}`);
            error.code = 'api_error';
            throw error;
          }

          const data = await response.json();
          const choice = data.choices && data.choices[0];
          if (!choice) {
            const error = new Error('No completion choices returned');
            error.code = 'api_error';
            throw error;
          }
          return {
            role: choice.message.role || 'assistant',
            content: (choice.message.content || '').trim()
          };
        } catch (error) {
          console.error('ChatGPT call failed', error);
          if (!error.code) {
            error.code = 'network_error';
          }
          throw error;
        }
      }

      function fallbackSummary(stage, conversation) {
        const stageInfo = stageConfig[stage];
        if (!conversation.length) {
          return `No dialogue captured yet for the ${stageInfo.title} stage.`;
        }
        const userHighlights = conversation
          .filter((entry) => entry.role === 'user')
          .slice(-3)
          .map((entry, index) => `${index + 1}. ${entry.content}`);
        if (!userHighlights.length) {
          return `Dialogue was recorded, but only assistant responses are stored for the ${stageInfo.title} stage.`;
        }
        return [`Highlights from ${stageInfo.title}:`, ...userHighlights].join('\n');
      }

      async function summarizeStage(stage) {
        const conversation = loadConversation(stage);
        const stageInfo = stageConfig[stage];
        if (!stageInfo) return;

        if (!conversation.length) {
          setStageStatus(stage, 'Start a dialogue before requesting a summary.', 'warning');
          return;
        }

        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        let summaryText;
        let usedFallback = false;

        if (apiKey) {
          const conversationTranscript = conversation
            .map((entry) => `${entry.role.toUpperCase()}: ${entry.content}`)
            .join('\n');
          const messages = [
            {
              role: 'system',
              content:
                'You are a report automation assistant who condenses PPSS design conversations into concise, insight-rich summaries.'
            },
            {
              role: 'user',
              content: `${stageInfo.summaryPrompt}\n\nDialogue:\n${conversationTranscript}`
            }
          ];
          try {
            const completion = await callChatGPT(messages, { apiKey });
            summaryText = completion.content || fallbackSummary(stage, conversation);
            if (!completion.content) {
              usedFallback = true;
            }
          } catch (error) {
            console.error('Summary generation failed', error);
            summaryText = fallbackSummary(stage, conversation);
            usedFallback = true;
          }
        } else {
          summaryText = fallbackSummary(stage, conversation);
          usedFallback = true;
        }

        localStorage.setItem(SUMMARY_KEY(stage), JSON.stringify({
          summary: summaryText,
          stage: stageInfo.title,
          timestamp: new Date().toISOString()
        }));
        persistStatus(stage, true);
        const statusMessage = usedFallback
          ? 'Local highlight summary saved to the report dashboard. Connect ChatGPT for richer synthesis.'
          : 'Stage summary saved to the report dashboard.';
        setStageStatus(stage, statusMessage, usedFallback ? 'warning' : 'success');
      }

      function handleChatSubmit(event) {
        event.preventDefault();
        const form = event.currentTarget;
        const input = form.querySelector('.chat-input');
        const message = input.value.trim();
        if (!message) return;
        input.value = '';

        const stage = form.dataset.stage;
        const stageInfo = stageConfig[stage];
        const chatLog = document.querySelector(`.chat-log[data-stage="${stage}"]`);
        const conversation = loadConversation(stage);

        appendMessage(chatLog, 'user', message);
        conversation.push({ role: 'user', content: message });
        saveConversation(stage, conversation);

        const pending = appendMessage(chatLog, 'assistant', 'Awaiting response from the ChatGPT API...', { pending: true });

        (async () => {
          const messages = [
            { role: 'system', content: stageInfo.systemPrompt },
            ...conversation
          ];
          try {
            const apiKey = localStorage.getItem(API_KEY_STORAGE);
            if (!apiKey) {
              const error = new Error('missing_api_key');
              error.code = 'missing_api_key';
              throw error;
            }
            const completion = await callChatGPT(messages, { apiKey });
            pending.remove();
            if (!completion.content) {
              return;
            }
            const assistantRole = completion.role || 'assistant';
            appendMessage(chatLog, assistantRole, completion.content);
            conversation.push({ role: assistantRole, content: completion.content });
            saveConversation(stage, conversation);
            const statusEl = document.querySelector(`.stage-content#${stage} .stage-status`);
            if (statusEl && (statusEl.classList.contains('warning') || statusEl.classList.contains('error'))) {
              setStageStatus(stage, '');
            }
          } catch (error) {
            pending.remove();
            const statusMessage =
              error.code === 'missing_api_key'
                ? 'Add your OpenAI API key in Settings to receive assistant replies.'
                : 'The platform could not reach the ChatGPT API. Check your credentials or try again shortly.';
            const statusClass = error.code === 'missing_api_key' ? 'warning' : 'error';
            setStageStatus(stage, statusMessage, statusClass);
          }
        })();
      }

      document.querySelectorAll('.chat-form').forEach((form) => {
        form.addEventListener('submit', handleChatSubmit);
      });

      completeButtons.forEach((button) => {
        button.addEventListener('click', () => summarizeStage(button.dataset.stage));
      });

      updateStageCompletionStyles();
      const defaultIndex = stageButtons.findIndex((button) => button.classList.contains('active'));
      showStage(defaultIndex >= 0 ? defaultIndex : 0);
      Object.keys(stageConfig).forEach((stage) => {
        const summaryInfo = parseStoredJSON(SUMMARY_KEY(stage), null);
        if (summaryInfo && summaryInfo.summary) {
          setStageStatus(stage, 'Summary ready for the report dashboard.', 'success');
        }
      });
    })();
  </script>
</body>
</html>

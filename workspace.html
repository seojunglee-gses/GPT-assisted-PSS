  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workspace | ChatGPT-assisted PPSS Platform</title>
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body>
  <nav class="sidebar">
    <div class="logo">PPSS</div>
    <ul>
      <li><a href="index.html"><span class="icon">üè†</span><span>Home</span></a></li>
      <li><a href="workspace.html" class="active"><span class="icon">üß†</span><span>Workspace</span></a></li>
      <li><a href="report.html"><span class="icon">üìä</span><span>Report</span></a></li>
      <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span>Settings</span></a></li>
    </ul>
  </nav>
  <main class="content workspace-main">
    <header class="workspace-header">
      <h1>Collaborative Workspace</h1>
      <p>
        Your collaborative space for planning. Discuss, design, and decide with AI support ‚Äî all in one place.
      </p>
    </header>

    <section class="workflow">
      <div class="stage-navigation" role="tablist" aria-label="Workspace stages">
        <button type="button" class="stage-step active" data-stage="problem-definition" data-index="0" role="tab"
          aria-selected="true">
          <span class="step-icon">üß≠</span>
          <span class="step-label">Problem Definition</span>
        </button>
        <button type="button" class="stage-step" data-stage="data-analysis" data-index="1" role="tab"
          aria-selected="false">
          <span class="step-icon">üìä</span>
          <span class="step-label">Data Analysis</span>
        </button>
        <button type="button" class="stage-step" data-stage="design-alternatives" data-index="2" role="tab"
          aria-selected="false">
          <span class="step-icon">üõ†Ô∏è</span>
          <span class="step-label">Design/Plan Alternatives</span>
        </button>
        <button type="button" class="stage-step" data-stage="design-evaluation" data-index="3" role="tab"
          aria-selected="false">
          <span class="step-icon">üîç</span>
          <span class="step-label">Design/Plan Evaluation</span>
        </button>
        <button type="button" class="stage-step" data-stage="design-decision" data-index="4" role="tab"
          aria-selected="false">
          <span class="step-icon">üìë</span>
          <span class="step-label">Design/Plan Decision</span>
        </button>
      </div>

      <div class="stage-progress" aria-hidden="true">
        <div class="stage-progress__track">
          <div class="stage-progress__fill" style="width: 0%"></div>
        </div>
        <span class="stage-progress__label">Stage 1 of 5</span>
      </div>

      <div class="stage-container">
        <article id="problem-definition" class="stage-content active" role="tabpanel">
          <div class="stage-grid">
            <div class="stage-panel narrative-panel">
              <figure class="hero-figure">
                <img src="https://mediahub.seoul.go.kr/wp-content/uploads/2015/10/5de7c238a28ee44f5547a19fdc0c2b13.jpg"
                  alt="Seoul Station Overpass Study Area" />
                <figcaption>Maps of the Seoullo site near Seoul Station. Left: The site's location within Seoul. 
                  Right: The Seoullo site and its surrounding areas, highlighting key neighbourhoods such as 
                  Jungnim-dong and Seogye-dong to the west, and Hoehyeon-dong residential area and Namdaemun Market to the east.</figcaption>
              </figure>
              <div class="panel-copy">
                <h2>Seoul Station Overpass</h2>
                <p>
                  The Seoul Station Overpass, constructed in 1970 after its groundbreaking in March 1969, 
                  is an elevated concrete roadway that once symbolized the rapid modernization of Seoul. 
                  Stretching approximately 1.024 kilometers in length and 10.3 meters in width, the bridge spans
                  the city‚Äôs central railway corridor, connecting districts long divided by rail lines. The overpass is 
                  supported by T-shaped concrete piers, with its highest point reaching 17 meters above ground level. 
                </p>
                <p> 
                  However, decades of aging led to growing safety concerns and ultimately restricted vehicle use. 
                  With its structural integrity rated at a low D-level and vehicle load limits reduced to 26 tons, 
                  the viaduct‚Äôs deterioration made clear the need for an alternative vision ‚Äî one rooted in urban 
                  regeneration rather than demolition.
                </p>
                <p>
                  The project seeks to transform this obsolete automobile infrastructure into a dynamic urban space that 
                  reconnects fragmented districts, revitalizes surrounding communities, and provides a sustainable model 
                  for participatory city planning. The overpass area sits at the heart of Seoul, surrounded by Seoul 
                  Station, Namdaemun Market, Namsan, Cheongpa-dong, Jungnim-dong, and Hoehyeon-dong ‚Äî neighborhoods that 
                  encompass a diverse mix of cultural heritage, small industries such as garment manufacturing, transient 
                  populations, and long-term residents. These communities have suffered from physical isolation due to 
                  railways and major roads, resulting in economic decline and social fragmentation. Yet their dense urban 
                  fabric, historical depth, and active civic groups offer rich potential for inclusive regeneration.
                </p>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2> Agent</h2>
                <p class="chat-description">Understand the project background and define key issues together.
                  Users discuss local problems, share concerns, and suggest ideas through dialogue.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="problem-definition">
                <div class="message user">
                  <span class="role">Resident</span>
                  <p>My neighborhood is cut off from the railroad and suffers from poor infrastructure. How can urban regeneration projects mitigate this?</p>
                </div>
                <div class="message assistant">
                  <span class="role">Assistant</span>
                </div> </b>1. Improving Connectivity and Overcoming Spatial Barriers:</b>
                      One of the primary issues is that the railway acts as a physical barrier, leading to
                      spatial and social isolation in your neighborhood. The elevated road near Seoul
                      Station also has limited accessibility. Here are strategies that could help:
                <br>
                      Creating Pedestrian Bridges or Underpasses: Since the elevated road and
                      railway separate the neighborhood from other parts of the city, constructing
                      well-designed pedestrian bridges or underpasses would provide better
                      access and reduce the isolation created by the railway.
                <br>
                  Public Transport Integration: Improved access to public transportation, such
                  as building new bus stops or enhancing connections to subway stations,
                  would reduce the feeling of isolation by making it easier for residents to
                  move across the city (Project Knowledge) . This could help connect your
                  neighborhood with the more developed areas on the east side of Seoul Station.
                </P>
                <p>
                </b>2. Upgrading Poor Infrastructure:</b>
                  The lack of modern infrastructure is another critical problem. Addressing this
                  requires a multi-pronged approach:
                <br>
                  Enhancing Roads and Streets: Upgrading the road network to accommodate
                  both vehicles and pedestrians is crucial. Narrow, hilly alleyways, which are
                  part of the area's historical charm, could be preserved while making them
                  more accessible and safer. Additionally, adding bike lanes
                  and improving walkability through pedestrian-friendly zones aligns with
                  broader trends in urban regeneration.
                <br>
                  Utility Upgrades: Enhancing basic utilities like water supply, waste
                  management, and street lighting would significantly improve the quality of
                  life in the area. For instance, relocating the garbage truck garage could free
                  up space for more useful infrastructure like parks or public squares.
                </p>
                <p>
                  </b>3. Reintegrating Marginalized Spaces Through Regeneration:</b>
                  The spatial separation has contributed to social and political marginalization.
                  Urban regeneration can help reintegrate the neighborhood into the broader
                  urban fabric by:
                <br>
                  Public Spaces and Community Hubs: Developing public spaces or
                  community hubs around historical and cultural landmarks (such as nearby
                  parks, markets, or industrial heritage sites) can bridge the gap between the
                  underdeveloped west and the more prosperous east.
                  This could include repurposing the area under the elevated road as a green
                  park, market, or community center.
                <br>
                  Cultural and Heritage Tourism: Promoting cultural and industrial heritage
                  sites in your neighborhood could stimulate tourism and local business,
                  integrating your neighborhood more fully into the city's social and economic
                  landscape.
                </p>
                <p>
                  </b>4. Sustainable Development and Green Spaces:</b>
                  The project should incorporate sustainability principles that are often found in
                  urban regeneration efforts. This includes:
                <br>
                  Green Spaces: Building parks and green spaces where residents can gather
                  not only improves aesthetics but also makes the area more livable. The
                  removal of the garbage truck garage offers an opportunity to develop such
                  spaces, making the area more attractive.
                <br>
                  Eco-Friendly Infrastructure: Incorporating renewable energy sources like
                  solar panels on public buildings or using eco-friendly materials in
                  construction can contribute to both environmental sustainability and the
                  neighborhood's overall appeal.
                </p>
                <p>
                  </b>5. Leveraging Historical and Cultural Significance:</b>
                  Your neighborhood's history, especially its preservation of old alleyways and
                  historical landmarks, can be turned into an asset. During regeneration, emphasis
                  on preserving and celebrating these features can attract both locals and tourists,
                  leading to better economic and social integration.
                </p>
                <p>
                  </b>Summary of Key Solutions:</b>
                  ‚ñ∑ Construct pedestrian bridges and improve public transport links to overcome
                  the railway barrier.
                <br>
                  ‚ñ∑ Upgrade roads, utilities, and public infrastructure to improve living
                  conditions.
                <br>
                  ‚ñ∑ Create public spaces or community hubs near historical sites to enhance
                  social reintegration.
                <br>
                  ‚ñ∑ Develop green spaces and sustainable infrastructure to boost livability.
                 <br>
                  ‚ñ∑ Preserve historical alleyways and promote cultural tourism to attract
                  attention and resources.
                  <br>
                  By following these strategies, the urban regeneration project can help reconnect
                  your neighborhood with the rest of Seoul, improve infrastructure, and enhance
                  residents' quality of life.
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="problem-definition">
                <label class="visually-hidden" for="message-stage-1">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-1" class="chat-input" type="text" name="message"
                    placeholder="Compose your prompt..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="problem-definition">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="data-analysis" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel analysis-panel">
              <h2>Evidence Canvases</h2>
              <p>Select a tab to review the synthesized evidence captured for the data analysis stage.</p>
              <div class="data-tabs" role="tablist" aria-label="Data analysis evidence tabs">
                <button type="button" class="data-tab active" data-tab="patterns" role="tab" aria-selected="true">789 Art Zone</button>
                <button type="button" class="data-tab" data-tab="painpoints" role="tab" aria-selected="false">Gyeungui Line Forest Park</button>
                <button type="button" class="data-tab" data-tab="opportunities" role="tab" aria-selected="false">Highline Park</button>
              </div>
              <div class="data-tab-content active" id="patterns" role="tabpanel">
                <img src="https://museumofwander.com/wp-content/uploads/2023/03/DSC00795.jpg"
                  alt="789 Art Zone in Beijing, China" />
                <p>
                  The 798 Art Zone (also known as Dashanzi Art District) in Beijing is a globally recognized urban regeneration project 
                  that transformed a 1950s military electronics factory complex into China‚Äôs leading contemporary art hub. Originally 
                  part of the 718 Joint Project, the Bauhaus-style industrial complex was built in collaboration with East Germany and served 
                  as a model socialist factory‚Äîa self-contained community providing housing, schools, and healthcare for its workers.
                 </p>
                 <p>
                  Following China‚Äôs economic reforms in the 1980s, production declined, and the complex was abandoned. 
                  In the mid-1990s, artists such as Sui Jianguo, Huang Rui, and Liu Suola began occupying the vacant spaces, 
                  attracted by low rent and spacious, light-filled interiors. This spontaneous occupation marked the first phase 
                  (‚Äúincubation period‚Äù) of the district‚Äôs rebirth as a creative enclave.
                 </p>
                 <p>
                  In the early 2000s, the ‚ÄúSeven Star Group‚Äù, a state enterprise owning the site, sought to demolish the buildings 
                  for redevelopment. In response, artists organized exhibitions such as Reconstruction 798 and the Dashanzi International 
                  Art Festival (2004‚Äì2006), drawing international attention and civic support. The city government ultimately protected 798
                  as a cultural heritage site, designating it a ‚ÄúCreative Cultural Industries Cluster‚Äù in 2008.
                 </p>
                 <p>
                  Today, 798 Art Zone covers 138 hectares in Beijing‚Äôs Chaoyang District, featuring art galleries, design studios, 
                  caf√©s, and creative companies. It attracts both domestic and international visitors and plays a key role in Beijing‚Äôs
                  city branding. However, rapid commercialization and rising rents have pushed many pioneering artists to relocate to
                  cheaper districts like Caochangdi and Songzhuang, raising concerns about gentrification and the loss of 798‚Äôs avant-garde spirit.
                 </p>
                 <p>
                  Despite this, the zone remains a symbol of China‚Äôs cultural transformation, representing the intersection of industrial 
                  heritage reuse, creative economy, and state-led urban marketing. It embodies the paradox of contemporary Chinese 
                  urbanism‚Äîbalancing artistic freedom, economic pragmatism, and government control.
                 </p>
                 <p>
                  Key themes:
                  ‚ñ∑ Adaptive reuse of socialist industrial heritage (Bauhaus architecture)
                  ‚ñ∑ Emergence from grassroots artist occupation to state-recognized cultural hub
                  ‚ñ∑ Integration into Beijing‚Äôs global city marketing strategy
                  ‚ñ∑ Tensions between artistic authenticity and commercialization
                  ‚ñ∑ Influence on similar creative clusters across China (e.g., Shanghai‚Äôs M50, Chengdu, Kunming)
                </p>
              </div>
              <div class="data-tab-content" id="painpoints" role="tabpanel" hidden>
                <img src="https://parks.seoul.go.kr/images/egovframework/com/template/gus3.jpg"
                  alt="Gyeungui Line Forest Park in Seoul, Korea" />
                <p>
                  The Gyeongui Line Forest Park in Seoul is a major urban regeneration project that transformed an abandoned 
                  railway corridor into a linear green space stretching approximately 6.3 km from Gajwa Station to Yongsan
                  Community Center. Initiated in 2009 as part of the city‚Äôs regeneration plan, it reconnects neighborhoods 
                  once divided by the railway and enhances the quality of urban life by returning disused land to the public.
                </p>
                <p>
                  The project originated from a 2004 Seoul Institute study on reusing idle rail land and was implemented in 
                  stages‚Äîbeginning with the Daeheung section (760 m) in 2012 and expanding through Yeonnam-dong and Yeomni-dong. 
                  The park‚Äôs design integrates green space with pedestrian accessibility, linking surrounding neighborhoods and 
                  commercial areas while absorbing local pedestrian traffic into its flow.
                </p>
                 <p>
                  A key characteristic of the Gyeongui Line Forest Park is its strong emphasis on citizen participation. In 2014, 
                  the city and Mapo District established ‚ÄúGyeongui Line Forest Keepers‚Äù (Gyeongui-seon Supgil-jigi)‚Äîa nonprofit 
                  organization modeled after New York‚Äôs Friends of the High Line. This group includes residents, designers, students,
                  and local officials who collaborate to manage and activate the park through community-based programs such as cultural 
                  events, gardening, environmental cleanups, and public art projects (White Butterfly Project).
                </p>
                <p>
                  The park has become a vibrant urban space where citizens and visitors gather for leisure and cultural activities, 
                  especially in the Yeonnam-dong area near Hongdae. However, it also faces challenges like gentrification, waste management,
                  and pedestrian‚Äìcyclist safety conflicts. Local forums and initiatives have been organized to mitigate these issues and ensure
                  sustainable coexistence between long-term residents and newcomers.
                </p>
                <p>
                  The Gyeongui Line Forest Park exemplifies adaptive reuse of post-industrial infrastructure through participatory governance, 
                  aligning with global trends such as New York‚Äôs High Line and Paris‚Äôs Promenade Plant√©e. It symbolizes Seoul‚Äôs shift from 
                  government-driven redevelopment toward citizen-led urban regeneration, where community stewardship shapes the identity and sustainability of public spaces.
                </p>
                <p>
                  Key themes:
                  ‚ñ∑ Transformation of an abandoned railway into a linear urban park
                  ‚ñ∑ Citizen-led management through Gyeongui Line Forest Keepers
                  ‚ñ∑ Cultural and ecological revitalization of neighborhoods
                  ‚ñ∑ Challenges of gentrification and inclusive urban regeneration
                </p>
              </div>
              <div class="data-tab-content" id="opportunities" role="tabpanel" hidden>
                <img src="https://cdn.vox-cdn.com/thumbor/vfP32EdfHssHtEknAq-I1Tyv0Zw=/0x0:2000x1333/2070x828/filters:focal(840x507:1160x827):format(webp)/cdn.vox-cdn.com/uploads/chorus_image/image/63748975/Highline_Guide_Max_Touhey_20190416_0082.0.jpg"
                  alt="Highline Park in New York, USA" />
                <p>
                  The High Line Park is an elevated linear park in Manhattan, New York City, created from an abandoned freight rail 
                  line that once ran through the Chelsea district. Originally built in the 1930s to prevent frequent traffic accidents 
                  between trains and vehicles on 10th Avenue‚Äîonce known as ‚ÄúDeath Avenue‚Äù‚Äîthe railway operated until 1980 before being 
                  closed and neglected for decades.
                </p>
                <p>       
                  In the 1990s, the structure faced demolition, but local residents organized a civic movement called Friends of 
                  the High Line (FHL) to preserve and repurpose it as a public park. Founded by Joshua David and Robert Hammond in 1999,
                  the group succeeded in convincing the city and property owners to support redevelopment instead of removal.
                </p>
                <p>
                  A public‚Äìprivate partnership between the City of New York and FHL led to the park‚Äôs creation. The city allowed developers 
                  to transfer development rights from nearby lots, while FHL raised $3.5 million and the city invested $15.75 million, later 
                  increased by Mayor Michael Bloomberg to a total of $43.25 million. In 2003, an international design competition attracted 
                  720 teams from 36 countries. The winning proposal came from Field Operations (landscape architecture) and Diller Scofidio 
                  + Renfro (architecture), whose design integrated nature and urban infrastructure through the concept of ‚ÄúAgri-tecture‚Äù
                  ‚Äîa hybrid of agriculture and architecture.
                </p>
                <p>
                  Opened in stages from 2009, the High Line preserves the industrial character of the area while introducing sustainable 
                  greenery, wooden decks, and pedestrian paths that blend with the city‚Äôs skyline. The park provides a serene walking
                  experience above the bustling streets, offering views of the Hudson River and Manhattan‚Äôs buildings.
                </p>
                <p>
                  Today, the High Line stands as a symbol of urban regeneration, transforming a decaying industrial relic into a vibrant 
                  public space that promotes ecological design, cultural vitality, and social inclusivity. It also reinforced New York‚Äôs
                  identity as a city capable of turning ‚Äúurban scars‚Äù into celebrated landmarks.
                </p>
                <p>
                  Key themes:
                  ‚ñ∑ Adaptive reuse of obsolete infrastructure
                  ‚ñ∑ Citizen-led activism and public‚Äìprivate collaboration
                  ‚ñ∑ Integration of nature and urban life (Agri-tecture)
                  ‚ñ∑ Model for sustainable urban regeneration and placemaking
                </p>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2>Analytical Dialogue</h2>
                <p class="chat-description">Interrogate datasets with contextual prompts and retrieve quantitative or qualitative
                  insights generated via the ChatGPT API.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="data-analysis">
                <div class="message assistant">
                  <span class="role">Assistant</span>
                  <p>I can summarize the variance in ridership across weekdays versus weekends. Would you like a chart-ready
                    breakdown?</p>
                </div>
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="data-analysis">
                <label class="visually-hidden" for="message-stage-2">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-2" class="chat-input" type="text" name="message"
                    placeholder="Ask about anomalies, clusters, or correlations..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="data-analysis">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="design-alternatives" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel gallery-panel">
              <h2>Concept Visualizations</h2>
              <p>
                Preview images generated through the ChatGPT image pipeline to provoke conversations on modular service concepts.
              </p>
              <div class="image-strip">
                <figure>
                  <img src="https://images.unsplash.com/photo-1535223289827-42f1e9919769?auto=format&fit=crop&w=800&q=60"
                    alt="Futuristic eco-friendly shuttle design" />
                  <figcaption>Autonomous shuttle concept with adaptive lighting.</figcaption>
                </figure>
                <figure>
                  <img src="https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=800&q=60"
                    alt="Smart mobility service hub at dusk" />
                  <figcaption>Service hub integrating micro-mobility drop-off points.</figcaption>
                </figure>
                <figure>
                  <img src="https://images.unsplash.com/photo-1529429617124-aee5b8d711b5?auto=format&fit=crop&w=800&q=60"
                    alt="Interior of an accessible transit pod" />
                  <figcaption>Universal design interior layout for inclusive commuting.</figcaption>
                </figure>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2>Co-creation Dialogue</h2>
                <p class="chat-description">Iterate on alternative concepts, assess feasibility, and request synthesized design
                  briefs from the ChatGPT API.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="design-alternatives">
                <div class="message assistant">
                  <span class="role">Assistant</span>
                  <p>Shall I compare the lifecycle emissions for the three proposed shuttle configurations?</p>
                </div>
                <div class="message user">
                  <span class="role">Engineer</span>
                  <p>Yes, prioritize recycled materials and modular upgrades for long-term adaptability.</p>
                </div>
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="design-alternatives">
                <label class="visually-hidden" for="message-stage-3">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-3" class="chat-input" type="text" name="message"
                    placeholder="Describe a new alternative..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="design-alternatives">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="design-evaluation" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel evaluation-panel">
              <h2>Prototype Snapshots</h2>
              <p>Review the captured evidence from service pilots to determine the viability of shortlisted alternatives.</p>
              <div class="photo-grid">
                <figure class="evaluation-photo" data-image-id="prototype-shuttle">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1529429617124-aee5b8d711b5?auto=format&fit=crop&w=1400&q=80"
                      alt="Passengers boarding a prototype shuttle" />
                    <button type="button" class="photo-zoom" aria-label="View passengers boarding a prototype shuttle">
                      <span aria-hidden="true">üîç</span>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Live usability study on the adaptive shuttle entry sequence.</figcaption>
                  <label class="ranking-control" for="rank-prototype-shuttle">
                    <span>Assign a rank</span>
                    <select id="rank-prototype-shuttle" class="ranking-select" data-image-id="prototype-shuttle">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 ‚Äî Leading Concept</option>
                      <option value="2">Rank 2 ‚Äî Strong Contender</option>
                      <option value="3">Rank 3 ‚Äî Needs Refinement</option>
                      <option value="4">Rank 4 ‚Äî Backup Option</option>
                      <option value="5">Rank 5 ‚Äî Limited Fit</option>
                      <option value="6">Rank 6 ‚Äî Low Alignment</option>
                      <option value="7">Rank 7 ‚Äî Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="telemetry-dashboard">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?auto=format&fit=crop&w=1400&q=80"
                      alt="Designers reviewing analytics on a large screen" />
                    <button type="button" class="photo-zoom" aria-label="View designers reviewing analytics on a large screen">
                      <span aria-hidden="true">üîç</span>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Integrated telemetry dashboard tracking energy consumption.</figcaption>
                  <label class="ranking-control" for="rank-telemetry-dashboard">
                    <span>Assign a rank</span>
                    <select id="rank-telemetry-dashboard" class="ranking-select" data-image-id="telemetry-dashboard">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 ‚Äî Leading Concept</option>
                      <option value="2">Rank 2 ‚Äî Strong Contender</option>
                      <option value="3">Rank 3 ‚Äî Needs Refinement</option>
                      <option value="4">Rank 4 ‚Äî Backup Option</option>
                      <option value="5">Rank 5 ‚Äî Limited Fit</option>
                      <option value="6">Rank 6 ‚Äî Low Alignment</option>
                      <option value="7">Rank 7 ‚Äî Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="accessibility-trials">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1492724441997-5dc865305da7?auto=format&fit=crop&w=1400&q=80"
                      alt="Facilitators testing accessibility features" />
                    <button type="button" class="photo-zoom" aria-label="View facilitators testing accessibility features">
                      <span aria-hidden="true">üîç</span>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Accessibility trials focusing on seamless transfers.</figcaption>
                  <label class="ranking-control" for="rank-accessibility-trials">
                    <span>Assign a rank</span>
                    <select id="rank-accessibility-trials" class="ranking-select" data-image-id="accessibility-trials">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 ‚Äî Leading Concept</option>
                      <option value="2">Rank 2 ‚Äî Strong Contender</option>
                      <option value="3">Rank 3 ‚Äî Needs Refinement</option>
                      <option value="4">Rank 4 ‚Äî Backup Option</option>
                      <option value="5">Rank 5 ‚Äî Limited Fit</option>
                      <option value="6">Rank 6 ‚Äî Low Alignment</option>
                      <option value="7">Rank 7 ‚Äî Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="mobility-hub-render">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1529429617124-95b38d21fc4d?auto=format&fit=crop&w=1400&q=80"
                      alt="Rendering of a modular mobility hub" />
                    <button type="button" class="photo-zoom" aria-label="View rendering of a modular mobility hub">
                      <span aria-hidden="true">üîç</span>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Regenerative mobility hub with modular charging canopies.</figcaption>
                  <label class="ranking-control" for="rank-mobility-hub-render">
                    <span>Assign a rank</span>
                    <select id="rank-mobility-hub-render" class="ranking-select" data-image-id="mobility-hub-render">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 ‚Äî Leading Concept</option>
                      <option value="2">Rank 2 ‚Äî Strong Contender</option>
                      <option value="3">Rank 3 ‚Äî Needs Refinement</option>
                      <option value="4">Rank 4 ‚Äî Backup Option</option>
                      <option value="5">Rank 5 ‚Äî Limited Fit</option>
                      <option value="6">Rank 6 ‚Äî Low Alignment</option>
                      <option value="7">Rank 7 ‚Äî Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="service-app-ui">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1523475472560-d2df97ec485c?auto=format&fit=crop&w=1400&q=80"
                      alt="Prototype mobile service application" />
                    <button type="button" class="photo-zoom" aria-label="View prototype mobile service application">
                      <span aria-hidden="true">üîç</span>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Service orchestration app highlighting multimodal journeys.</figcaption>
                  <label class="ranking-control" for="rank-service-app-ui">
                    <span>Assign a rank</span>
                    <select id="rank-service-app-ui" class="ranking-select" data-image-id="service-app-ui">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 ‚Äî Leading Concept</option>
                      <option value="2">Rank 2 ‚Äî Strong Contender</option>
                      <option value="3">Rank 3 ‚Äî Needs Refinement</option>
                      <option value="4">Rank 4 ‚Äî Backup Option</option>
                      <option value="5">Rank 5 ‚Äî Limited Fit</option>
                      <option value="6">Rank 6 ‚Äî Low Alignment</option>
                      <option value="7">Rank 7 ‚Äî Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="energy-dashboard">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1526498460520-4c246339dccb?auto=format&fit=crop&w=1400&q=80"
                      alt="Energy monitoring dashboard" />
                    <button type="button" class="photo-zoom" aria-label="View energy monitoring dashboard">
                      <span aria-hidden="true">üîç</span>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Energy intelligence overlay for service fleet dispatch.</figcaption>
                  <label class="ranking-control" for="rank-energy-dashboard">
                    <span>Assign a rank</span>
                    <select id="rank-energy-dashboard" class="ranking-select" data-image-id="energy-dashboard">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 ‚Äî Leading Concept</option>
                      <option value="2">Rank 2 ‚Äî Strong Contender</option>
                      <option value="3">Rank 3 ‚Äî Needs Refinement</option>
                      <option value="4">Rank 4 ‚Äî Backup Option</option>
                      <option value="5">Rank 5 ‚Äî Limited Fit</option>
                      <option value="6">Rank 6 ‚Äî Low Alignment</option>
                      <option value="7">Rank 7 ‚Äî Retire Concept</option>
                    </select>
                  </label>
                </figure>
                <figure class="evaluation-photo" data-image-id="community-lab">
                  <div class="photo-wrapper">
                    <img src="https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1400&q=80"
                      alt="Community co-design lab" />
                    <button type="button" class="photo-zoom" aria-label="View community co-design lab">
                      <span aria-hidden="true">üîç</span>
                    </button>
                    <span class="ranking-badge" hidden></span>
                  </div>
                  <figcaption>Community co-design lab capturing inclusive feedback.</figcaption>
                  <label class="ranking-control" for="rank-community-lab">
                    <span>Assign a rank</span>
                    <select id="rank-community-lab" class="ranking-select" data-image-id="community-lab">
                      <option value="">Unranked</option>
                      <option value="1">Rank 1 </option>
                      <option value="2">Rank 2 </option>
                      <option value="3">Rank 3 </option>
                      <option value="4">Rank 4 </option>
                      <option value="5">Rank 5 </option>
                      <option value="6">Rank 6 </option>
                      <option value="7">Rank 7 </option>
                    </select>
                  </label>
                </figure>
              </div>
            </div>
            <div class="stage-panel chat-panel">
              <header>
                <h2>Evaluation Dialogue</h2>
                <p class="chat-description">Deploy the ChatGPT API to quantify trade-offs, narrate customer journeys, and prioritize
                  refinements.</p>
              </header>
              <div class="chat-log" aria-live="polite" data-stage="design-evaluation">
                <div class="message assistant">
                  <span class="role">Assistant</span>
                  <p>I can simulate the service level impact if we scale the adaptive shuttle fleet. Should I run the scenario?</p>
                </div>
              </div>
              <form class="chat-form" aria-label="Send a message to ChatGPT" data-stage="design-evaluation">
                <label class="visually-hidden" for="message-stage-4">Message</label>
                <div class="chat-composer">
                  <input id="message-stage-4" class="chat-input" type="text" name="message"
                    placeholder="Request comparative evaluations or metrics..." required />
                  <button type="submit" class="chat-send" aria-label="Send message">Send</button>
                </div>
              </form>
              <div class="stage-actions">
                <button type="button" class="complete-stage" data-stage="design-evaluation">Complete Stage</button>
                <p class="stage-status" aria-live="polite"></p>
              </div>
            </div>
          </div>
        </article>

        <article id="design-decision" class="stage-content" role="tabpanel" hidden>
          <div class="stage-grid">
            <div class="stage-panel report-panel">
              <h2>Design/Plan Decision Narrative</h2>
              <p>
                Consolidate insight streams into a transparent recommendation for the proactive product-service system strategy.
              </p>
              <div class="report-body">
                <h3>Executive Summary</h3>
                <p>
                  The integrated mobility service reduces per-passenger emissions by 28% compared to the baseline. Customer
                  satisfaction improves through predictive scheduling and inclusive design touchpoints.
                </p>
                <h3>Decision Criteria</h3>
                <ul>
                  <li>Adaptive routing lowers congestion events by 18% during peak windows.</li>
                  <li>Energy-efficient materials extend vehicle lifecycles by 22%.</li>
                  <li>Service partnerships unlock three new regenerative revenue streams.</li>
                </ul>
                <h3>Next Steps</h3>
                <p>
                  Scale the telemetry stack across partner fleets, finalize stakeholder governance, and prepare a policy briefing
                  aligned with the article's recommendations.
                </p>
              </div>
            </div>
            <div class="stage-panel decision-panel">
              <h2>Design Preference Table</h2>
              <p>Rank each concept in the evaluation gallery to build a transparent preference profile for final selection.</p>
              <div class="decision-table-wrapper">
                <table class="decision-table">
                  <thead>
                    <tr>
                      <th scope="col">Concept</th>
                      <th scope="col">Contributor</th>
                      <th scope="col">Assigned Rank</th>
                      <th scope="col">Preference Index</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr data-image-id="prototype-shuttle">
                      <th scope="row">Adaptive Shuttle Entry</th>
                      <td>Team Aurora</td>
                      <td class="decision-rank">Unranked</td>
                      <td class="decision-preference">
                        <div class="preference-meter" aria-hidden="true"><span style="width: 0%"></span></div>
                        <span class="preference-label">Awaiting evaluation</span>
                      </td>
                    </tr>
                    <tr data-image-id="telemetry-dashboard">
                      <th scope="row">Telemetry Intelligence Wall</th>
                      <td>Data Studio Kilo</td>
                      <td class="decision-rank">Unranked</td>
                      <td class="decision-preference">
                        <div class="preference-meter" aria-hidden="true"><span style="width: 0%"></span></div>
                        <span class="preference-label">Awaiting evaluation</span>
                      </td>
                    </tr>
                    <tr data-image-id="accessibility-trials">
                      <th scope="row">Inclusive Boarding Trials</th>
                      <td>Accessibility Guild</td>
                      <td class="decision-rank">Unranked</td>
                      <td class="decision-preference">
                        <div class="preference-meter" aria-hidden="true"><span style="width: 0%"></span></div>
                        <span class="preference-label">Awaiting evaluation</span>
                      </td>
                    </tr>
                    <tr data-image-id="mobility-hub-render">
                      <th scope="row">Regenerative Mobility Hub</th>
                      <td>Studio Meridian</td>
                      <td class="decision-rank">Unranked</td>
                      <td class="decision-preference">
                        <div class="preference-meter" aria-hidden="true"><span style="width: 0%"></span></div>
                        <span class="preference-label">Awaiting evaluation</span>
                      </td>
                    </tr>
                    <tr data-image-id="service-app-ui">
                      <th scope="row">Service Orchestration App</th>
                      <td>Digital Team Nova</td>
                      <td class="decision-rank">Unranked</td>
                      <td class="decision-preference">
                        <div class="preference-meter" aria-hidden="true"><span style="width: 0%"></span></div>
                        <span class="preference-label">Awaiting evaluation</span>
                      </td>
                    </tr>
                    <tr data-image-id="energy-dashboard">
                      <th scope="row">Energy Dispatch Dashboard</th>
                      <td>Telemetry Collective</td>
                      <td class="decision-rank">Unranked</td>
                      <td class="decision-preference">
                        <div class="preference-meter" aria-hidden="true"><span style="width: 0%"></span></div>
                        <span class="preference-label">Awaiting evaluation</span>
                      </td>
                    </tr>
                    <tr data-image-id="community-lab">
                      <th scope="row">Community Co-design Lab</th>
                      <td>Engagement Network</td>
                      <td class="decision-rank">Unranked</td>
                      <td class="decision-preference">
                        <div class="preference-meter" aria-hidden="true"><span style="width: 0%"></span></div>
                        <span class="preference-label">Awaiting evaluation</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </article>
      </div>
    </section>
  </main>

  <div class="evaluation-lightbox" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="lightbox-backdrop" data-close="true"></div>
    <div class="lightbox-content">
      <button type="button" class="lightbox-close" aria-label="Close expanded prototype image" data-close="true">‚úï</button>
      <img class="lightbox-image" src="" alt="" />
      <p class="lightbox-caption"></p>
    </div>
  </div>

  <script>
    (function () {
      const stageButtons = Array.from(document.querySelectorAll('.stage-step'));
      const stageContents = Array.from(document.querySelectorAll('.stage-content'));
      const tabButtons = Array.from(document.querySelectorAll('.data-tab'));
      const tabPanels = Array.from(document.querySelectorAll('.data-tab-content'));
      const completeButtons = Array.from(document.querySelectorAll('.complete-stage'));
      const progressFill = document.querySelector('.stage-progress__fill');
      const progressLabel = document.querySelector('.stage-progress__label');
      const stageCount = stageButtons.length || 1;
      const STORAGE_PREFIX = 'ppss';
      const CONVERSATION_KEY = (stage) => `${STORAGE_PREFIX}-conversation-${stage}`;
      const SUMMARY_KEY = (stage) => `${STORAGE_PREFIX}-summary-${stage}`;
      const STATUS_KEY = `${STORAGE_PREFIX}-stage-status`;
      const API_KEY_STORAGE = `${STORAGE_PREFIX}-openai-key`;
      const RANKING_KEY = `${STORAGE_PREFIX}-evaluation-rankings`;

      const stageConfig = {
        'problem-definition': {
          title: 'Problem Definition',
          systemPrompt:
            'You are a proactive product-service system strategist who helps teams clarify PPSS problem statements, stakeholder drivers, and sustainability intentions.',
          summaryPrompt:
            'Summarize the PPSS problem-definition dialogue into a short paragraph highlighting the core challenge, stakeholder commitments, and sustainability intentions.'
        },
        'data-analysis': {
          title: 'Data Analysis',
          systemPrompt:
            'You are a PPSS data analyst who explains trends, anomalies, and correlations for mobility service transformation.',
          summaryPrompt:
            'Summarize the evidence interrogation by listing the most critical demand, pain point, and opportunity signals uncovered for the PPSS initiative.'
        },
        'design-alternatives': {
          title: 'Design/Plan Alternatives',
          systemPrompt:
            'You are a PPSS co-creation assistant who compares and refines alternative service concepts with lifecycle awareness.',
          summaryPrompt:
            'Summarize the alternative generation dialogue, focusing on leading concepts, differentiating value, and feasibility considerations.'
        },
        'design-evaluation': {
          title: 'Design/Plan Evaluation',
          systemPrompt:
            'You are a PPSS evaluation advisor who narrates pilot results, quantifies trade-offs, and recommends refinements.',
          summaryPrompt:
            'Summarize the evaluation dialogue, emphasizing tested scenarios, key metrics, and recommended refinements for scale-up.'
        }
      };

      function parseStoredJSON(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch (error) {
          console.warn('Unable to parse storage for', key, error);
          return fallback;
        }
      }

      const stageStatus = parseStoredJSON(STATUS_KEY, {});
      const rankingStore = parseStoredJSON(RANKING_KEY, {});

      function persistStatus(stage, completed) {
        stageStatus[stage] = completed;
        localStorage.setItem(STATUS_KEY, JSON.stringify(stageStatus));
        updateStageCompletionStyles();
      }

      function updateStageCompletionStyles() {
        stageButtons.forEach((button) => {
          const { stage } = button.dataset;
          const isComplete = Boolean(stageStatus[stage]);
          button.classList.toggle('completed', isComplete);
        });
      }

      function showStage(index) {
        stageButtons.forEach((btn, idx) => {
          const isActive = idx === index;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });

        stageContents.forEach((panel, idx) => {
          const shouldShow = idx === index;
          panel.classList.toggle('active', shouldShow);
          panel.toggleAttribute('hidden', !shouldShow);
        });

        if (progressFill) {
          const percent = stageCount > 1 ? (index / (stageCount - 1)) * 100 : 100;
          progressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
        }

        if (progressLabel) {
          progressLabel.textContent = `Stage ${index + 1} of ${stageCount}`;
        }
      }

      stageButtons.forEach((button, index) => {
        button.addEventListener('click', () => showStage(index));
      });

      const evaluationPhotos = Array.from(document.querySelectorAll('.evaluation-photo'));
      const lightbox = document.querySelector('.evaluation-lightbox');
      const lightboxImg = lightbox?.querySelector('.lightbox-image');
      const lightboxCaption = lightbox?.querySelector('.lightbox-caption');

      function openLightbox(img, caption) {
        if (!lightbox || !lightboxImg || !lightboxCaption) return;
        lightboxImg.src = img.currentSrc || img.src;
        lightboxImg.alt = img.alt || '';
        lightboxCaption.textContent = caption || '';
        lightbox.classList.add('open');
        lightbox.removeAttribute('hidden');
        lightbox.setAttribute('aria-hidden', 'false');
        document.body.classList.add('lightbox-open');
      }

      function closeLightbox() {
        if (!lightbox || !lightboxImg || !lightboxCaption) return;
        lightbox.classList.remove('open');
        lightbox.setAttribute('aria-hidden', 'true');
        lightbox.setAttribute('hidden', '');
        lightboxImg.src = '';
        lightboxImg.alt = '';
        lightboxCaption.textContent = '';
        document.body.classList.remove('lightbox-open');
      }

      evaluationPhotos.forEach((figure) => {
        const img = figure.querySelector('img');
        const caption = figure.querySelector('figcaption')?.textContent || '';
        const zoomButton = figure.querySelector('.photo-zoom');

        function handleOpen() {
          if (img) {
            openLightbox(img, caption);
          }
        }

        if (img) {
          img.addEventListener('click', handleOpen);
        }

        if (zoomButton) {
          zoomButton.addEventListener('click', handleOpen);
        }
      });

      if (lightbox) {
        lightbox.addEventListener('click', (event) => {
          if (event.target instanceof HTMLElement && event.target.dataset.close === 'true') {
            closeLightbox();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && lightbox.classList.contains('open')) {
            closeLightbox();
          }
        });
      }

      function updateRankingBadge(figure, value) {
        const badge = figure.querySelector('.ranking-badge');
        if (!badge) return;
        if (!value) {
          badge.textContent = '';
          badge.hidden = true;
          figure.classList.remove('is-ranked');
          return;
        }
        const label = `Rank ${value}`;
        badge.textContent = label;
        badge.hidden = false;
        figure.classList.add('is-ranked');
      }

      function persistRankings() {
        localStorage.setItem(RANKING_KEY, JSON.stringify(rankingStore));
      }

      const rankingSelects = Array.from(document.querySelectorAll('.ranking-select'));
      const decisionRows = Array.from(document.querySelectorAll('.decision-table tbody tr[data-image-id]'));

      function computePreference(rankValue) {
        const rankNumber = Number(rankValue);
        if (!rankValue || Number.isNaN(rankNumber)) {
          return {
            label: 'Awaiting evaluation',
            width: '0%',
            rankText: 'Unranked'
          };
        }

        const bounded = Math.max(1, Math.min(7, rankNumber));
        const preferencePercent = Math.round(((8 - bounded) / 7) * 100);
        const qualitative =
          bounded === 1
            ? 'Priority candidate'
            : bounded <= 3
            ? 'Preferred direction'
            : bounded <= 5
            ? 'Viable alternative'
            : 'Limited alignment';

        return {
          label: `${qualitative} ¬∑ ${preferencePercent}% affinity`,
          width: `${preferencePercent}%`,
          rankText: `Rank ${bounded}`
        };
      }

      function updateDecisionTable() {
        decisionRows.forEach((row) => {
          const { imageId } = row.dataset;
          const rankCell = row.querySelector('.decision-rank');
          const preferenceCell = row.querySelector('.decision-preference');
          if (!imageId || !rankCell || !preferenceCell) return;

          const storedRank = rankingStore[imageId];
          const preferenceInfo = computePreference(storedRank);
          rankCell.textContent = preferenceInfo.rankText;

          const meter = preferenceCell.querySelector('.preference-meter span');
          const label = preferenceCell.querySelector('.preference-label');

          if (meter) {
            meter.style.width = preferenceInfo.width;
          }

          if (label) {
            label.textContent = preferenceInfo.label;
          }
        });
      }

      rankingSelects.forEach((select) => {
        const { imageId } = select.dataset;
        if (!imageId) return;
        const figure = document.querySelector(`.evaluation-photo[data-image-id="${imageId}"]`);
        const storedValue = rankingStore[imageId];
        if (storedValue) {
          select.value = storedValue;
          if (figure) {
            updateRankingBadge(figure, storedValue);
          }
        }

        select.addEventListener('change', () => {
          const value = select.value;
          if (value) {
            rankingStore[imageId] = value;
          } else {
            delete rankingStore[imageId];
          }
          if (figure) {
            updateRankingBadge(figure, value);
          }
          persistRankings();
          updateDecisionTable();
        });
      });

      updateDecisionTable();

      function showTab(id) {
        tabButtons.forEach((btn) => {
          const isActive = btn.dataset.tab === id;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });

        tabPanels.forEach((panel) => {
          const shouldShow = panel.id === id;
          panel.classList.toggle('active', shouldShow);
          panel.toggleAttribute('hidden', !shouldShow);
        });
      }

      tabButtons.forEach((button) => {
        button.addEventListener('click', () => showTab(button.dataset.tab));
      });

      function loadConversation(stage) {
        return parseStoredJSON(CONVERSATION_KEY(stage), []);
      }

      function saveConversation(stage, conversation) {
        localStorage.setItem(CONVERSATION_KEY(stage), JSON.stringify(conversation));
      }

      function appendMessage(chatLog, role, content, options = {}) {
        const message = document.createElement('div');
        message.className = `message ${role}${options.pending ? ' pending' : ''}`;
        const roleLabel = role === 'assistant' ? 'Assistant' : role === 'system' ? 'System' : 'You';
        const roleSpan = document.createElement('span');
        roleSpan.className = 'role';
        roleSpan.textContent = roleLabel;
        const body = document.createElement('p');
        body.textContent = content;
        message.append(roleSpan, body);
        chatLog.appendChild(message);
        chatLog.scrollTop = chatLog.scrollHeight;
        return message;
      }

      function renderStoredConversation(stage) {
        const chatLog = document.querySelector(`.chat-log[data-stage="${stage}"]`);
        if (!chatLog) return;
        const stored = loadConversation(stage);
        stored.forEach((entry) => {
          appendMessage(chatLog, entry.role, entry.content);
        });
      }

      Object.keys(stageConfig).forEach(renderStoredConversation);

      function setStageStatus(stage, message, statusClass = '') {
        const container = document.querySelector(`.stage-content#${stage} .stage-status`);
        if (!container) return;
        container.textContent = message;
        container.className = `stage-status ${statusClass}`.trim();
      }

      async function callChatGPT(messages, options = {}) {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        if (!apiKey) {
          return {
            role: 'assistant',
            content:
              'Set your OpenAI API key in Settings to stream live responses. Until then, the workspace will log your prompts locally.',
            error: true
          };
        }

        try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: options.model || 'gpt-4o',
              messages,
              temperature: 0.4
            })
          });

          if (!response.ok) {
            throw new Error(`OpenAI error: ${response.status}`);
          }

          const data = await response.json();
          const choice = data.choices && data.choices[0];
          if (!choice) throw new Error('No completion choices returned');
          return {
            role: choice.message.role || 'assistant',
            content: choice.message.content
          };
        } catch (error) {
          console.error('ChatGPT call failed', error);
          return {
            role: 'assistant',
            content:
              'The platform could not reach the ChatGPT API. Review your API key, network access, or usage limits and try again.',
            error: true
          };
        }
      }

      function fallbackSummary(stage, conversation) {
        const stageInfo = stageConfig[stage];
        if (!conversation.length) {
          return `No dialogue captured yet for the ${stageInfo.title} stage.`;
        }
        const userHighlights = conversation
          .filter((entry) => entry.role === 'user')
          .slice(-3)
          .map((entry, index) => `${index + 1}. ${entry.content}`);
        if (!userHighlights.length) {
          return `Dialogue was recorded, but only assistant responses are stored for the ${stageInfo.title} stage.`;
        }
        return [`Highlights from ${stageInfo.title}:`, ...userHighlights].join('\n');
      }

      async function summarizeStage(stage) {
        const conversation = loadConversation(stage);
        const stageInfo = stageConfig[stage];
        if (!stageInfo) return;

        if (!conversation.length) {
          setStageStatus(stage, 'Start a dialogue before requesting a summary.', 'warning');
          return;
        }

        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        let summaryText;

        if (apiKey) {
          const conversationTranscript = conversation
            .map((entry) => `${entry.role.toUpperCase()}: ${entry.content}`)
            .join('\n');
          const messages = [
            {
              role: 'system',
              content:
                'You are a report automation assistant who condenses PPSS design conversations into concise, insight-rich summaries.'
            },
            {
              role: 'user',
              content: `${stageInfo.summaryPrompt}\n\nDialogue:\n${conversationTranscript}`
            }
          ];
          const completion = await callChatGPT(messages, { model: 'gpt-4o' });
          summaryText = completion.error ? fallbackSummary(stage, conversation) : completion.content;
        } else {
          summaryText = fallbackSummary(stage, conversation);
        }

        localStorage.setItem(SUMMARY_KEY(stage), JSON.stringify({
          summary: summaryText,
          stage: stageInfo.title,
          timestamp: new Date().toISOString()
        }));
        persistStatus(stage, true);
        setStageStatus(stage, 'Stage summary saved to the report dashboard.', 'success');
      }

      function handleChatSubmit(event) {
        event.preventDefault();
        const form = event.currentTarget;
        const input = form.querySelector('.chat-input');
        const message = input.value.trim();
        if (!message) return;
        input.value = '';

        const stage = form.dataset.stage;
        const stageInfo = stageConfig[stage];
        const chatLog = document.querySelector(`.chat-log[data-stage="${stage}"]`);
        const conversation = loadConversation(stage);

        appendMessage(chatLog, 'user', message);
        conversation.push({ role: 'user', content: message });
        saveConversation(stage, conversation);

        const pending = appendMessage(chatLog, 'assistant', 'Awaiting response from the ChatGPT API...', { pending: true });

        (async () => {
          const messages = [
            { role: 'system', content: stageInfo.systemPrompt },
            ...conversation
          ];
          const completion = await callChatGPT(messages);
          pending.remove();
          const assistantRole = completion.role || 'assistant';
          appendMessage(chatLog, assistantRole, completion.content);
          conversation.push({ role: assistantRole, content: completion.content });
          saveConversation(stage, conversation);
        })();
      }

      document.querySelectorAll('.chat-form').forEach((form) => {
        form.addEventListener('submit', handleChatSubmit);
      });

      completeButtons.forEach((button) => {
        button.addEventListener('click', () => summarizeStage(button.dataset.stage));
      });

      updateStageCompletionStyles();
      const defaultIndex = stageButtons.findIndex((button) => button.classList.contains('active'));
      showStage(defaultIndex >= 0 ? defaultIndex : 0);
      Object.keys(stageConfig).forEach((stage) => {
        const summaryInfo = parseStoredJSON(SUMMARY_KEY(stage), null);
        if (summaryInfo && summaryInfo.summary) {
          setStageStatus(stage, 'Summary ready for the report dashboard.', 'success');
        }
      });
    })();
  </script>
</body>
</html>
